@using Freedle.Web.ViewModels
@model MessagesViewModel

@{
    ViewData["Title"] = "Съобщения";
}

<h2>Съобщения</h2>

<div style="display: flex;">
    <!-- Листа с разговорите -->
    <div style="width: 30%; border-right: 1px solid #ccc; padding-right: 10px;">
        <h3>Вашите разговори</h3>
        <ul>
            @foreach (var conversation in Model.Conversations)
            {
                <li>
                    <a href="#" onclick="loadChat('@conversation.Id', '@conversation.OtherUserName'); return false;">
                        @conversation.OtherUserName
                    </a>
                </li>
            }
        </ul>
    </div>

    <!-- Чатът -->
    <div style="width: 70%; padding-left: 20px;">
        <h3 id="chatHeader">Изберете разговор</h3>
        <ul id="messagesList"></ul>

        <input type="text" id="messageInput" placeholder="Вашето съобщение" style="display:none;" />
        <button id="sendButton" style="display:none;">Изпрати</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    var currentConversationId = null;
    var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

    connection.start().catch(err => console.error(err.toString()));

    function loadChat(conversationId, userName) {
        currentConversationId = conversationId;

        // Променяме заглавието на чата
        document.getElementById("chatHeader").innerText = "Чат с " + userName;

        // Показваме полетата за писане
        document.getElementById("messageInput").style.display = "block";
        document.getElementById("sendButton").style.display = "block";

        // Изчистваме старите съобщения
        document.getElementById("messagesList").innerHTML = "";

        // Зареждаме съобщенията чрез AJAX
        fetch(`/Home/GetMessages?conversationId=${conversationId}`)
            .then(response => response.json())
            .then(messages => {
                messages.forEach(msg => {
                    var li = document.createElement("li");
                    li.textContent = `${msg.senderName}: ${msg.content}`;
                    document.getElementById("messagesList").appendChild(li);
                });

                // Присъединяваме се към SignalR групата
                connection.invoke("JoinConversation", conversationId);
            })
            .catch(err => console.error(err));
    }

    connection.on("ReceiveMessage", function (user, message) {
        var li = document.createElement("li");
        li.textContent = `${user}: ${message}`;
        document.getElementById("messagesList").appendChild(li);
    });

    document.getElementById("sendButton").addEventListener("click", function () {
        var message = document.getElementById("messageInput").value;
        if (currentConversationId) {
            connection.invoke("SendMessage", currentConversationId, "@Model.CurrentUserId", message)
                .catch(err => console.error(err.toString()));
        }
    });
</script>
